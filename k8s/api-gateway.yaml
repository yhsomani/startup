apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    worker_processes auto;
    events { worker_connections 1024; }
    http {
        include       /etc/nginx/mime.types;
        default_type  application/json;
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for" '
                          'rt=$request_time urt="$upstream_response_time"';
        access_log  /var/log/nginx/access.log  main;
        error_log   /var/log/nginx/error.log   warn;

        limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;
        limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
        limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=2r/s;

        upstream flask_backend { server flask:5000; }
        upstream dotnet_backend { server dotnet:8080; }
        upstream springboot_backend { server springboot:8080; }
        upstream notification_backend { server notification-service:3030; }
        upstream assistant_backend { server backend-assistant:5005; }
        upstream recruitment_backend { server backend-recruitment:5006; }
        upstream gamification_backend { server backend-gamification:5007; }

        server {
            listen 80;
            server_name localhost;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header 'X-Gateway-Service' 'api-gateway' always;

            location / {
                if ($request_method = 'OPTIONS') {
                    add_header 'Access-Control-Allow-Origin' '*';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
                    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-User-Id';
                    add_header 'Access-Control-Max-Age' 1728000;
                    add_header 'Content-Type' 'text/plain; charset=utf-8';
                    add_header 'Content-Length' 0;
                    return 204;
                }
                add_header 'Access-Control-Allow-Origin' '*' always;
            }

            location = /health {
                default_type text/plain;
                return 200 "API Gateway is healthy";
            }

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-Id $http_x_user_id;
            proxy_set_header X-User-Role $http_x_user_role;
            proxy_http_version 1.1;
            proxy_buffering off;

            location /api/v1/auth/ {
                limit_req zone=auth_limit burst=10 nodelay;
                proxy_pass http://flask_backend;
            }
            location /api/v1/challenges/ {
                if ($request_uri ~* "/submit$") { limit_req zone=upload_limit burst=5 nodelay; }
                proxy_pass http://flask_backend;
            }
            location ~ ^/api/v1/(courses|sections|lessons)/ {
                if ($request_uri ~* "/video$") { limit_req zone=upload_limit burst=5 nodelay; }
                limit_req zone=api_limit burst=20 nodelay;
                proxy_pass http://dotnet_backend;
            }
            location ~ ^/api/v1/(enrollments|progress|certificates|users/search|users/.*/certificates) {
                limit_req zone=api_limit burst=20 nodelay;
                proxy_pass http://springboot_backend;
            }
            location /api/v1/assistant/ {
                limit_req zone=api_limit burst=20 nodelay;
                proxy_pass http://assistant_backend;
            }
            location /api/v1/candidates/ {
                limit_req zone=api_limit burst=20 nodelay;
                proxy_pass http://recruitment_backend;
            }
            location /api/v1/users/ {
                limit_req zone=api_limit burst=20 nodelay;
                proxy_pass http://gamification_backend;
            }
            location /ws/notifications/ {
                proxy_pass http://notification_backend;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";
            }
            
            error_page 429 /429.json;
            location = /429.json { return 429 '{"error": "rate_limit_exceeded"}'; }
            error_page 500 502 503 504 /50x.json;
            location = /50x.json { return 503 '{"error": "service_unavailable"}'; }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
spec:
  replicas: 2
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
        livenessProbe:
            httpGet:
                path: /health
                port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
spec:
  type: LoadBalancer 
  selector:
    app: api-gateway
  ports:
  - port: 80
    targetPort: 80
