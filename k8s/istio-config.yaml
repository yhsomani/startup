# Istio Service Mesh Configuration
# Provides: mTLS, traffic management, observability

---
# 1. Enable mTLS for namespace
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: talentsphere
spec:
  mtls:
    mode: STRICT

---
# 2. Authorization policies
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: api-gateway-authz
  namespace: talentsphere
spec:
  selector:
    matchLabels:
      app: api-gateway
  action: ALLOW
  rules:
    - from:
        - source:
            principals: ['cluster.local/ns/ingress-nginx/serviceaccounts/default']
    - to:
        - operation:
            methods: ['GET', 'POST', 'PUT', 'DELETE']
            paths: ['/api/*']

---
# 3. Backend services authorization
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: backend-authz
  namespace: talentsphere
spec:
  selector:
    matchLabels:
      tier: backend
  action: ALLOW
  rules:
    - from:
        - source:
            principals: ['cluster.local/ns/talentsphere/serviceaccounts/api-gateway']
        - source:
            principals: ['cluster.local/ns/talentsphere/serviceaccounts/backend-*']

---
# 4. Traffic routes - canary deployment
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: api-gateway-canary
  namespace: talentsphere
spec:
  hosts:
    - api-gateway
  http:
    - name: primary
      match:
        - headers:
            x-canary:
              exact: 'false'
      route:
        - destination:
            host: api-gateway
            subset: stable
          weight: 90
    - name: canary
      match:
        - headers:
            x-canary:
              exact: 'true'
      route:
        - destination:
            host: api-gateway
            subset: canary
          weight: 100

---
# 5. Destination rules
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: api-gateway-destination
  namespace: talentsphere
spec:
  host: api-gateway
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    loadBalancer:
      simple: LEAST_REQUEST
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary

---
# 6. Service entries for external APIs
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: stripe-api
  namespace: talentsphere
spec:
  hosts:
    - api.stripe.com
  location: MESH_EXTERNAL
  ports:
    - number: 443
      name: https
      protocol: HTTPS
  resolution: DNS

---
# 7. Envoy filters for custom headers
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: add-correlation-header
  namespace: talentsphere
spec:
  workloadSelector:
    labels:
      app: api-gateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        listener:
          filterChain:
            filter:
              name: envoy.filters.http.router
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.lua
          typed_config:
            '@type': type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
            inlineCode: |
              function envoy_on_request(request_handle)
                local correlation_id = request_handle:headers():get("x-correlation-id")
                if correlation_id == nil then
                  correlation_id = os.uuid()
                end
                request_handle:headers():add("x-correlation-id", correlation_id)
              end

---
# 8. Telemetry for observability
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: mesh-telemetry
  namespace: talentsphere
spec:
  tracing:
    - providers:
        - name: jaeger
      randomSamplingPercentage: 10.0
  metrics:
    - providers:
        - name: prometheus
  accessLogging:
    - providers:
        - name: envoy
