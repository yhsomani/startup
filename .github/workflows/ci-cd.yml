name: TalentSphere CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    release:
        types: [published]

env:
    NODE_VERSION: "18"
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    # Lint and Code Quality
    lint:
        name: Lint & Code Quality
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Run security audit
              run: npm audit --audit-level=high

            - name: Check code formatting
              run: npm run format:check

    # Testing
    test:
        name: Test Suite
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [16, 18, 20]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Start test services
              run: |
                  docker-compose -f docker-compose.test.yml up -d
                  sleep 10

            - name: Run unit tests
              run: npm run test:unit
              env:
                  NODE_ENV: test

            - name: Run integration tests
              run: npm run test:integration
              env:
                  NODE_ENV: test

            - name: Run E2E tests
              run: npm run test:e2e
              env:
                  NODE_ENV: test

            - name: Generate coverage report
              run: npm run test:coverage

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella

            - name: Stop test services
              if: always()
              run: docker-compose -f docker-compose.test.yml down -v

    # Build
    build:
        name: Build Application
        runs-on: ubuntu-latest
        needs: [lint, test]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build application
              run: npm run build
              env:
                  NODE_ENV: production

            - name: Upload build artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: build-files
                  path: |
                      dist/
                      build/
                      *.tar.gz

            - name: Bundle size analysis
              run: npm run analyze:bundle

    # Security Scan
    security:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: [lint, test]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Run Snyk security scan
              uses: snyk/actions/node@master
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --severity-threshold=high

    # Docker Build
    docker:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: [build, security]
        outputs:
            image-digest: ${{ steps.build.outputs.digest }}
            image-tag: ${{ steps.meta.outputs.tags }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix={{branch}}-

            - name: Build and push Docker image
              id: build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  platforms: linux/amd64,linux/arm64

    # Deploy to Staging
    deploy-staging:
        name: Deploy to Staging
        runs-on: ubuntu-latest
        needs: [docker]
        if: github.ref == 'refs/heads/develop'
        environment: staging
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to staging
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.STAGING_HOST }}
                  username: ${{ secrets.STAGING_USER }}
                  key: ${{ secrets.STAGING_SSH_KEY }}
                  script: |
                      cd /var/www/talentsphere-staging
                      docker-compose -f docker-compose.staging.yml pull
                      docker-compose -f docker-compose.staging.yml up -d --remove-orphans
                      docker system prune -f

            - name: Run health checks
              run: |
                  sleep 30
                  curl -f ${{ secrets.STAGING_URL }}/health || exit 1

    # Deploy to Production
    deploy-production:
        name: Deploy to Production
        runs-on: ubuntu-latest
        needs: [docker]
        if: github.event_name == 'release'
        environment: production
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to production
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.PRODUCTION_HOST }}
                  username: ${{ secrets.PRODUCTION_USER }}
                  key: ${{ secrets.PRODUCTION_SSH_KEY }}
                  script: |
                      cd /var/www/talentsphere
                      docker-compose -f docker-compose.prod.yml pull
                      docker-compose -f docker-compose.prod.yml up -d --remove-orphans
                      docker system prune -f

            - name: Run health checks
              run: |
                  sleep 30
                  curl -f ${{ secrets.PRODUCTION_URL }}/health || exit 1

            - name: Notify deployment success
              uses: 8398a7/action-slack@v3
              if: success()
              with:
                  status: success
                  channel: "#deployments"
                  text: "ðŸš€ TalentSphere deployed to production successfully!"

            - name: Notify deployment failure
              uses: 8398a7/action-slack@v3
              if: failure()
              with:
                  status: failure
                  channel: "#deployments"
                  text: "âŒ TalentSphere production deployment failed!"

    # Performance Testing
    performance:
        name: Performance Testing
        runs-on: ubuntu-latest
        needs: [deploy-staging]
        if: github.ref == 'refs/heads/develop'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Lighthouse CI
              uses: treosh/lighthouse-ci-action@v10
              with:
                  urls: |
                      ${{ secrets.STAGING_URL }}
                      ${{ secrets.STAGING_URL }}/login
                      ${{ secrets.STAGING_URL }}/dashboard
                  configPath: "./lighthouserc.json"
                  uploadArtifacts: true
                  temporaryPublicStorage: true

            - name: Run k6 performance test
              uses: grafana/k6-action@v0.3.0
              with:
                  filename: tests/performance/load-test.js
              env:
                  K6_PROMETHEUS_REMOTE_URL: ${{ secrets.PROMETHEUS_URL }}

    # Database Migrations
    migrate:
        name: Database Migrations
        runs-on: ubuntu-latest
        needs: [deploy-staging, deploy-production]
        if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run database migrations
              run: |
                  if [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
                    echo "Running migrations for staging..."
                    npm run migrate:staging
                  fi

                  if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
                    echo "Running migrations for production..."
                    npm run migrate:production
                  fi
              env:
                  DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
                  DATABASE_URL_PRODUCTION: ${{ secrets.DATABASE_URL_PRODUCTION }}

    # Cleanup
    cleanup:
        name: Cleanup
        runs-on: ubuntu-latest
        needs: [deploy-staging, deploy-production, performance, migrate]
        if: always()
        steps:
            - name: Clean up old Docker images
              run: |
                  docker system prune -af --filter "until=72h"
                  docker volume prune -f

            - name: Clean up old artifacts
              uses: actions/github-script@v6
              with:
                  script: |
                      const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                         owner: context.repo.owner,
                         repo: context.repo.repo,
                         run_id: context.runId,
                      });

                      const toDelete = artifacts.data.artifacts
                         .filter(artifact => {
                           const createdAt = new Date(artifact.created_at);
                           const daysOld = (Date.now() - createdAt.getTime()) / (1000 * 60 * 60 * 24);
                           return daysOld > 30;
                         })
                         .map(artifact => artifact.id);

                      for (const artifactId of toDelete) {
                        await github.rest.actions.deleteArtifact({
                           owner: context.repo.owner,
                           repo: context.repo.repo,
                           artifact_id: artifactId,
                        });
                      }
